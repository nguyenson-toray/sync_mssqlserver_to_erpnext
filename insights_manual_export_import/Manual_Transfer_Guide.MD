# HÆ°á»›ng Dáº«n Export/Import Thá»§ CÃ´ng Insights Data

## ðŸ“‹ Tá»•ng Quan

Script `insights_manual_export_import.py` Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ export Insights data thÃ nh cÃ¡c file cÃ³ thá»ƒ transfer thá»§ cÃ´ng giá»¯a cÃ¡c servers khÃ¡c nhau.

### âœ¨ TÃ­nh NÄƒng:
- ðŸ—ƒï¸ **Export Ä‘a Ä‘á»‹nh dáº¡ng**: JSON, SQL, CSV
- ðŸ“¦ **Táº¡o ZIP package** chá»©a táº¥t cáº£ formats
- ðŸ”„ **Import tá»± Ä‘á»™ng** tá»« JSON hoáº·c ZIP
- ðŸ›¡ï¸ **Backup tá»± Ä‘á»™ng** trÆ°á»›c khi import
- ðŸ“Š **BÃ¡o cÃ¡o chi tiáº¿t** quÃ¡ trÃ¬nh export/import

### ðŸ“ CÃ¡c Data ÄÆ°á»£c Transfer:
- âœ… **Dashboards** - Báº£ng Ä‘iá»u khiá»ƒn
- âœ… **Workbooks** - Sá»• lÃ m viá»‡c  
- âœ… **Data Sources** - Nguá»“n dá»¯ liá»‡u
- âœ… **Charts** - Biá»ƒu Ä‘á»“
- âœ… **Queries** - Truy váº¥n
- âœ… **Settings** - CÃ i Ä‘áº·t

## ðŸ› ï¸ YÃªu Cáº§u Há»‡ Thá»‘ng

### TrÃªn Cáº£ 2 Servers:
- **ERPNext/Frappe Framework** Ä‘Ã£ cÃ i Ä‘áº·t
- **Insights App** Ä‘Ã£ cÃ i Ä‘áº·t
- **Python 3.x**
- **Quyá»n truy cáº­p** bench commands

### Kiá»ƒm Tra Insights App:
```bash
# Kiá»ƒm tra app
bench --site your-site list-apps | grep insights

# CÃ i Ä‘áº·t náº¿u chÆ°a cÃ³
bench get-app insights
bench --site your-site install-app insights
```

## ðŸ“¥ CÃ i Äáº·t Script

### 1. Táº£i Script
```bash
# Táº¡o thÆ° má»¥c
mkdir -p ~/insights-transfer
cd ~/insights-transfer

# Táº¡o script file
nano insights_manual_export_import.py
# (Copy ná»™i dung tá»« artifact)

# PhÃ¢n quyá»n
chmod +x insights_manual_export_import.py
```

### 2. Test Script
```bash
# Test script
python3 insights_manual_export_import.py
```

## ðŸš€ CÃ¡ch Sá»­ Dá»¥ng

### ðŸ“¤ EXPORT DATA (TrÃªn Server Nguá»“n)

#### 1. Export Sá»­ Dá»¥ng Bench Console (Khuyáº¿n nghá»‹)
```bash
cd ~/frappe-bench
bench --site erp-sonnt.tiqn.local console
```

Sau Ä‘Ã³ paste Ä‘oáº¡n code sau vÃ o console:
```python
import json
import os
from datetime import datetime

# Simple export function
timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
export_dir = f'insights_export_{timestamp}'
os.makedirs(export_dir, exist_ok=True)

doctypes = ['Insights Settings', 'Insights Data Source', 'Insights Query', 'Insights Chart', 'Insights Workbook', 'Insights Dashboard']

print(f'Starting export from {frappe.local.site}')
total_records = 0

for doctype in doctypes:
    try:
        if not frappe.db.exists('DocType', doctype):
            print(f'DocType {doctype} not found, skipping')
            continue
        
        records = frappe.get_all(doctype, fields=['name'])
        print(f'Found {len(records)} {doctype} records')
        
        if not records:
            continue
        
        full_records = []
        for record in records:
            try:
                doc = frappe.get_doc(doctype, record.name)
                doc_dict = doc.as_dict()
                
                system_fields = ['creation', 'modified', 'modified_by', 'owner', 'idx']
                for field in system_fields:
                    if field in doc_dict:
                        del doc_dict[field]
                
                full_records.append(doc_dict)
            except Exception as e:
                print(f'Error exporting {record.name}: {str(e)}')
        
        filename = f'{doctype.replace(" ", "_").lower()}.json'
        filepath = os.path.join(export_dir, filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(full_records, f, indent=2, default=str, ensure_ascii=False)
        
        total_records += len(full_records)
        print(f'Exported {len(full_records)} {doctype} records to {filename}')
        
    except Exception as e:
        print(f'Error processing {doctype}: {str(e)}')

print(f'Export completed! Files saved to: {export_dir}')
print(f'Total records exported: {total_records}')
```

**Output máº«u:**
```
Starting export from erp-sonnt.tiqn.local
Found 2 Insights Data Source records
Exported 2 Insights Data Source records to insights_data_source.json
Found 1 Insights Workbook records  
Exported 1 Insights Workbook records to insights_workbook.json
Export completed! Files saved to: insights_export_20250724_203809
Total records exported: 3
```

#### 2. Export Sá»­ Dá»¥ng Script (Thay tháº¿)
**âš ï¸ LÆ°u Ã½: Script cáº§n cháº¡y tá»« thÆ° má»¥c bench vÃ  cÃ³ thá»ƒ cáº§n sá»­a Ä‘Æ°á»ng dáº«n**

```bash
cd ~/frappe-bench
env/bin/python sync_mssqlserver_to_erpnext/sync_mssqlserver_to_erpnext/insights_manual_export_import/insights_manual_export_import.py export erp-sonnt.tiqn.local
```

### ðŸ“‚ Cáº¥u TrÃºc File Export

**Console Export (ThÆ° má»¥c JSON):**
```
~/frappe-bench/sites/insights_export_20250724_203809/
â”œâ”€â”€ insights_data_source.json        # Data source data (2 records)
â”œâ”€â”€ insights_workbook.json           # Workbook data (1 record)
â””â”€â”€ (cÃ¡c file khÃ¡c náº¿u cÃ³ data)
```

**Script Export (ZIP Package - náº¿u script hoáº¡t Ä‘á»™ng):**
```
insights_export_20240724_103015.zip
â”œâ”€â”€ export_summary.json              # TÃ³m táº¯t export
â”œâ”€â”€ insights_dashboard.json          # Dashboard data
â”œâ”€â”€ insights_chart.json              # Chart data  
â”œâ”€â”€ insights_query.json              # Query data
â”œâ”€â”€ insights_data_source.json        # Data source data
â”œâ”€â”€ insights_workbook.json           # Workbook data
â”œâ”€â”€ insights_settings.json           # Settings data
â”œâ”€â”€ insights_data.sql                # SQL dump
â””â”€â”€ csv/                             # CSV files
    â”œâ”€â”€ insights_dashboard.csv
    â”œâ”€â”€ insights_chart.csv
    â””â”€â”€ ...
```

**VÃ­ dá»¥ thá»±c táº¿ tá»« export gáº§n Ä‘Ã¢y:**
```
sites/insights_export_20250724_203809/
â”œâ”€â”€ insights_data_source.json        # 2 data sources: Site DB, Query Store
â””â”€â”€ insights_workbook.json           # 1 workbook: "Inline" vá»›i 2 queries vÃ  2 charts
```

## ðŸ“‹ Transfer Files Giá»¯a Servers

### PhÆ°Æ¡ng PhÃ¡p 1: SCP (Khuyáº¿n nghá»‹)
```bash
# Copy thÆ° má»¥c export tá»« console
scp -r ~/frappe-bench/sites/insights_export_20250724_203809/ user@target-server:~/insights-transfer/

# Copy ZIP file (náº¿u cÃ³ tá»« script)
scp ~/insights-transfer/insights_export_20240724_103015.zip user@target-server:~/insights-transfer/
```

### PhÆ°Æ¡ng PhÃ¡p 2: SFTP
```bash
sftp user@target-server
# Upload thÆ° má»¥c export
put -r ~/frappe-bench/sites/insights_export_20250724_203809/ ~/insights-transfer/
quit
```

### PhÆ°Æ¡ng PhÃ¡p 3: ZIP vÃ  Transfer
```bash
# Táº¡o ZIP tá»« export directory
cd ~/frappe-bench/sites/
zip -r insights_export_20250724_203809.zip insights_export_20250724_203809/

# Transfer ZIP
scp insights_export_20250724_203809.zip user@target-server:~/insights-transfer/

# TrÃªn server Ä‘Ã­ch: extract
cd ~/insights-transfer/
unzip insights_export_20250724_203809.zip
```

### PhÆ°Æ¡ng PhÃ¡p 4: Cloud Storage
```bash
# Upload lÃªn Google Drive/Dropbox/AWS S3
zip -r insights_export.zip ~/frappe-bench/sites/insights_export_*/
# Upload báº±ng web interface hoáº·c CLI tools
# Download trÃªn server Ä‘Ã­ch vÃ o ~/insights-transfer/
```

## ðŸ“¥ IMPORT DATA (TrÃªn Server ÄÃ­ch)

### 1. Import Sá»­ Dá»¥ng Bench Console (Khuyáº¿n nghá»‹)
```bash
cd ~/frappe-bench
bench --site erp.tiqn.local console
```

Sau Ä‘Ã³ paste Ä‘oáº¡n code sau vÃ o console:
```python
import json
import os
from datetime import datetime

def import_insights_data(import_dir):
    """Import insights data from exported JSON files"""
    
    print(f'ðŸš€ Starting import to {frappe.local.site}')
    print(f'ðŸ“ Import from: {import_dir}')
    
    # Táº¡o backup trÆ°á»›c khi import
    print('[INFO] Creating backup before import...')
    frappe.utils.backup.new_backup(ignore_files=True, backup_path_db='/tmp/')
    
    # Thá»© tá»± import theo dependency
    import_order = [
        "insights_settings.json",
        "insights_data_source.json", 
        "insights_query.json",
        "insights_chart.json",
        "insights_workbook.json",
        "insights_dashboard.json"
    ]
    
    total_imported = 0
    
    for filename in import_order:
        filepath = os.path.join(import_dir, filename)
        
        if not os.path.exists(filepath):
            print(f'File {filename} not found, skipping')
            continue
            
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                records = json.load(f)
                
            if not records:
                print(f'No records in {filename}')
                continue
                
            doctype = records[0].get('doctype')
            print(f'[INFO] Importing {len(records)} records to {doctype}')
            
            imported_count = 0
            for record in records:
                try:
                    # XÃ³a cÃ¡c field khÃ´ng cáº§n thiáº¿t
                    if 'doctype' in record:
                        del record['doctype']
                    
                    # Kiá»ƒm tra record Ä‘Ã£ tá»“n táº¡i chÆ°a
                    existing = None
                    try:
                        existing = frappe.get_doc(doctype, record['name'])
                        print(f'[INFO] Updated: {record.get("title", record["name"])}')
                        # Update existing record
                        for key, value in record.items():
                            setattr(existing, key, value)
                        existing.save()
                    except frappe.DoesNotExistError:
                        # Táº¡o record má»›i
                        new_doc = frappe.get_doc(record)
                        new_doc.doctype = doctype
                        new_doc.insert()
                        print(f'[INFO] Created: {record.get("title", record["name"])}')
                    
                    imported_count += 1
                    
                except Exception as e:
                    print(f'[ERROR] Failed to import {record.get("name", "unknown")}: {str(e)}')
            
            total_imported += imported_count
            print(f'âœ… Imported {imported_count}/{len(records)} records from {filename}')
            
        except Exception as e:
            print(f'[ERROR] Failed to process {filename}: {str(e)}')
    
    print(f'âœ… Import completed! Total records: {total_imported}')
    print('ðŸ”” Please verify your data in Insights app')
    
    return total_imported

# Sá»­ dá»¥ng function vá»›i Ä‘Æ°á»ng dáº«n export directory
import_dir = '/home/frappe/frappe-bench/insights-transfer/insights_export_20250724_203809'  # Sá»­a Ä‘Æ°á»ng dáº«n
import_insights_data(import_dir)
```

### 2. Import Sá»­ Dá»¥ng Script (Thay tháº¿)
```bash
cd ~/frappe-bench
env/bin/python sync_mssqlserver_to_erpnext/sync_mssqlserver_to_erpnext/insights_manual_export_import/insights_manual_export_import.py import erp.tiqn.local ~/insights-transfer/insights_export_20250724_203809/
```

**Output Import máº«u:**
```
ðŸš€ Starting import to erp.tiqn.local
ðŸ“ Import from: /home/frappe/frappe-bench/insights-transfer/insights_export_20250724_203809
[INFO] Creating backup before import...
[INFO] Importing 2 records to Insights Data Source
[INFO] Created: Site DB
[INFO] Created: Query Store  
âœ… Imported 2/2 records from insights_data_source.json
[INFO] Importing 1 records to Insights Workbook
[INFO] Created: Inline
âœ… Imported 1/1 records from insights_workbook.json
âœ… Import completed! Total records: 3
ðŸ”” Please verify your data in Insights app
```

## ðŸ”§ Scripts Tá»± Äá»™ng HÃ³a

### Export Script (`export_insights.sh`)
```bash
#!/bin/bash

SITE="erp-sonnt.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "ðŸš€ Starting Insights export..."

# Export
cd ~/frappe-bench
python3 $SCRIPT_PATH export $SITE

# TÃ¬m file export má»›i nháº¥t trong script directory
EXPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$EXPORT_FILE" ]; then
    echo "âœ… Export completed: $EXPORT_FILE"
    echo "ðŸ“‹ File size: $(du -h $EXPORT_FILE | cut -f1)"
    echo ""
    echo "ðŸ“¤ Transfer commands:"
    echo "   scp $EXPORT_FILE user@target-server:~/insights-transfer/"
    echo "   rsync -avz $EXPORT_FILE user@target-server:~/insights-transfer/"
else
    echo "âŒ No export file found!"
fi
```

### Import Script (`import_insights.sh`)
```bash
#!/bin/bash

SITE="erp.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "ðŸš€ Starting Insights import..."

# TÃ¬m file import má»›i nháº¥t trong script directory
IMPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$IMPORT_FILE" ]; then
    echo "ðŸ“¦ Import file: $IMPORT_FILE"
    echo "ðŸ“‹ File size: $(du -h $IMPORT_FILE | cut -f1)"
    
    # Import
    cd ~/frappe-bench
    python3 $SCRIPT_PATH import $SITE $IMPORT_FILE
    
    if [ $? -eq 0 ]; then
        echo "âœ… Import completed successfully!"
        echo "ðŸ”” Please check Insights app to verify data"
    else
        echo "âŒ Import failed!"
    fi
else
    echo "âŒ No import file found in $SCRIPT_DIR"
    echo "Available files:"
    ls -la $SCRIPT_DIR/insights_export_* 2>/dev/null || echo "   (none)"
fi
```

### Cháº¡y Scripts:
```bash
# TrÃªn server nguá»“n
chmod +x export_insights.sh
./export_insights.sh

# TrÃªn server Ä‘Ã­ch
chmod +x import_insights.sh  
./import_insights.sh
```

## ðŸ” Troubleshooting

### Lá»—i Export

#### 1. "Site not found"
```bash
# Kiá»ƒm tra sites
bench --site all list-sites

# Hoáº·c
ls sites/
```

#### 2. "DocType not found"
```bash
# Kiá»ƒm tra Insights app
bench --site erp-sonnt.tiqn.local list-apps | grep insights

# CÃ i Ä‘áº·t náº¿u thiáº¿u
bench --site erp-sonnt.tiqn.local install-app insights
```

#### 3. "Permission denied"
```bash
# Kiá»ƒm tra quyá»n trong script directory
ls -la ~/insights-transfer/

# Táº¡o thÆ° má»¥c náº¿u cáº§n
mkdir -p ~/insights-transfer
chmod 755 ~/insights-transfer
```

### Lá»—i Transfer

#### 1. "No space left on device"
```bash
# Kiá»ƒm tra dung lÆ°á»£ng
df -h

# Dá»n dáº¹p files cÅ© trong script directory
rm -f ~/insights-transfer/insights_export_*.zip
rm -rf ~/insights-transfer/insights_export_*/
```

#### 2. "Connection refused" (SCP)
```bash
# Kiá»ƒm tra SSH service trÃªn target
ssh user@target-server "sudo systemctl status ssh"

# Test connection
telnet target-server 22
```

#### 3. "File too large"
```bash
# NÃ©n file tá»‘t hÆ¡n
cd /tmp
zip -9 insights_export_compressed.zip insights_export_*.zip

# Hoáº·c chia nhá» file
split -b 100M insights_export_large.zip insights_part_
```

### Lá»—i Import

#### 1. "Import file not found"
```bash
# Kiá»ƒm tra file trong script directory
ls -la ~/insights-transfer/insights_export_*

# Kiá»ƒm tra ná»™i dung ZIP
unzip -l ~/insights-transfer/insights_export_*.zip
```

#### 2. "Backup failed"
```bash
# Táº¡o backup manual
bench --site erp.tiqn.local backup

# Hoáº·c skip backup (khÃ´ng khuyáº¿n nghá»‹)
# Sá»­a trong script: comment dÃ²ng backup
```

#### 3. "DocType not found in system"
```bash
# CÃ i Ä‘áº·t Insights app
bench --site erp.tiqn.local install-app insights

# Migrate
bench --site erp.tiqn.local migrate

# Restart
bench restart
```

## ðŸ“Š Kiá»ƒm Tra Káº¿t Quáº£

### 1. Xem Export Summary
```bash
# Giáº£i nÃ©n vÃ  xem summary
unzip -p ~/insights-transfer/insights_export_*.zip export_summary.json | python3 -m json.tool
```

### 2. Verify Import Data
```bash
# VÃ o Frappe console
bench --site erp.tiqn.local console
```

```python
# Kiá»ƒm tra sá»‘ lÆ°á»£ng records
doctypes = [
    "Insights Dashboard",
    "Insights Chart", 
    "Insights Query",
    "Insights Data Source",
    "Insights Workbook"
]

for dt in doctypes:
    try:
        count = frappe.db.count(dt)
        print(f"{dt}: {count} records")
    except:
        print(f"{dt}: DocType not found")

# Kiá»ƒm tra dashboard cá»¥ thá»ƒ
dashboards = frappe.get_all("Insights Dashboard", fields=["name", "title"])
for d in dashboards:
    print(f"Dashboard: {d.name} - {d.title}")
```

### 3. Test Trong Insights App
1. **Login** vÃ o ERPNext site Ä‘Ã­ch
2. **Má»Ÿ Insights app**
3. **Kiá»ƒm tra Dashboards** hiá»ƒn thá»‹
4. **Test Charts** render Ä‘Ãºng
5. **Verify Data Sources** connect Ä‘Æ°á»£c

## âš ï¸ LÆ°u Ã Quan Trá»ng

### TrÆ°á»›c Khi Export:
- âœ… **Backup site nguá»“n** Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n
- âœ… **Kiá»ƒm tra dung lÆ°á»£ng disk** trÃªn cáº£ 2 servers
- âœ… **Note láº¡i cÃ¡c custom settings** cÃ³ thá»ƒ bá»‹ máº¥t
- âœ… **Cháº¡y tá»« thÆ° má»¥c bench** (`~/frappe-bench`)

### TrÆ°á»›c Khi Import:
- âœ… **Backup site Ä‘Ã­ch** (import script tá»± Ä‘á»™ng lÃ m)
- âœ… **Äáº£m báº£o Insights app** Ä‘Ã£ cÃ i Ä‘áº·t vÃ  active
- âœ… **Kiá»ƒm tra version compatibility** giá»¯a 2 sites  
- âœ… **Sá»­a Ä‘Æ°á»ng dáº«n** trong import script cho Ä‘Ãºng

### Sau Khi Import: 
- âœ… **Test toÃ n bá»™ dashboards** hoáº¡t Ä‘á»™ng
- âœ… **Kiá»ƒm tra data sources** cÃ²n valid
- âœ… **Verify user permissions** trÃªn items má»›i
- âœ… **Update queries** náº¿u cáº§n thiáº¿t
- âœ… **Test charts render** Ä‘Ãºng dá»¯ liá»‡u

### Káº¿t Quáº£ Thá»±c Táº¿ (24/07/2025):
- âœ… **Export thÃ nh cÃ´ng**: 3 records (2 Data Sources + 1 Workbook)
- âœ… **Data Sources**: Site DB (MariaDB), Query Store (SQLite)  
- âœ… **Workbook**: "Inline" vá»›i 2 queries QC vÃ  2 charts tiáº¿ng Viá»‡t
- âœ… **Files táº¡o**: insights_data_source.json, insights_workbook.json

## ðŸŽ¯ Best Practices

### 1. Naming Convention
```bash
# Äáº·t tÃªn file cÃ³ Ã½ nghÄ©a
insights_export_$(date +%Y%m%d)_$(hostname)_to_production.zip
```

### 2. Documentation
```bash
# Táº¡o file ghi chÃº
cat > transfer_notes.txt << EOF
Transfer Date: $(date)
Source: erp-sonnt.tiqn.local  
Target: erp.tiqn.local
Exported Items:
- 5 Dashboards
- 12 Charts  
- 8 Queries
- 3 Data Sources
Notes: Transferred for production deployment
EOF
```

### 3. Version Control
```bash
# Git track export files (náº¿u cáº§n)
git add insights_export_*.zip
git commit -m "Export insights data for production transfer"
```

### 4. Automation
```bash
# Cron job Ä‘á»ƒ export Ä‘á»‹nh ká»³
0 2 * * 0 cd /home/frappe/frappe-bench && python3 ~/insights-transfer/insights_manual_export_import.py export erp-sonnt.tiqn.local >/tmp/export.log 2>&1
```

## ðŸ“ž Há»— Trá»£

### Log Files
```bash
# Check export logs
tail -f /tmp/insights_export_*/export.log

# Check import logs  
tail -f /tmp/insights_import.log
```

### Debug Mode
ThÃªm debug vÃ o script:
```python
def log(self, message, level="INFO"):
    timestamp = datetime.now().strftime('%H:%M:%S')
    log_msg = f"[{timestamp}] {level}: {message}"
    print(log_msg)
    
    # Debug file
    with open("/tmp/insights_debug.log", "a") as f:
        f.write(log_msg + "\n")
```

---

**ðŸ’¡ Pro Tips:**
- LuÃ´n test trÃªn dev environment trÆ°á»›c
- Sá»­ dá»¥ng rsync vá»›i `--progress` Ä‘á»ƒ track transfer lá»›n
- Compress ZIP vá»›i level 9 Ä‘á»ƒ tiáº¿t kiá»‡m bÄƒng thÃ´ng: `zip -9`
- Backup khÃ´ng chá»‰ data mÃ  cáº£ customizations