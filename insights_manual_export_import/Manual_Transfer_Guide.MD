# H∆∞·ªõng D·∫´n Export/Import Th·ªß C√¥ng Insights Data

## üìã T·ªïng Quan

Script `insights_manual_export_import.py` ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ export Insights data th√†nh c√°c file c√≥ th·ªÉ transfer th·ªß c√¥ng gi·ªØa c√°c servers kh√°c nhau.

### ‚ú® T√≠nh NƒÉng:
- üóÉÔ∏è **Export ƒëa ƒë·ªãnh d·∫°ng**: JSON, SQL, CSV
- üì¶ **T·∫°o ZIP package** ch·ª©a t·∫•t c·∫£ formats
- üîÑ **Import t·ª± ƒë·ªông** t·ª´ JSON ho·∫∑c ZIP
- üõ°Ô∏è **Backup t·ª± ƒë·ªông** tr∆∞·ªõc khi import
- üìä **B√°o c√°o chi ti·∫øt** qu√° tr√¨nh export/import

### üìÅ C√°c Data ƒê∆∞·ª£c Transfer:
- ‚úÖ **Dashboards** - B·∫£ng ƒëi·ªÅu khi·ªÉn
- ‚úÖ **Workbooks** - S·ªï l√†m vi·ªác  
- ‚úÖ **Data Sources** - Ngu·ªìn d·ªØ li·ªáu
- ‚úÖ **Charts** - Bi·ªÉu ƒë·ªì
- ‚úÖ **Queries** - Truy v·∫•n
- ‚úÖ **Settings** - C√†i ƒë·∫∑t

## üõ†Ô∏è Y√™u C·∫ßu H·ªá Th·ªëng

### Tr√™n C·∫£ 2 Servers:
- **ERPNext/Frappe Framework** ƒë√£ c√†i ƒë·∫∑t
- **Insights App** ƒë√£ c√†i ƒë·∫∑t
- **Python 3.x**
- **Quy·ªÅn truy c·∫≠p** bench commands

### Ki·ªÉm Tra Insights App:
```bash
# Ki·ªÉm tra app
bench --site your-site list-apps | grep insights

# C√†i ƒë·∫∑t n·∫øu ch∆∞a c√≥
bench get-app insights
bench --site your-site install-app insights
```

## üì• C√†i ƒê·∫∑t Script

### 1. T·∫£i Script
```bash
# T·∫°o th∆∞ m·ª•c
mkdir -p ~/insights-transfer
cd ~/insights-transfer

# T·∫°o script file
nano insights_manual_export_import.py
# (Copy n·ªôi dung t·ª´ artifact)

# Ph√¢n quy·ªÅn
chmod +x insights_manual_export_import.py
```

### 2. Test Script
```bash
# Test script
python3 insights_manual_export_import.py
```

## üöÄ C√°ch S·ª≠ D·ª•ng

### üì§ EXPORT DATA (Tr√™n Server Ngu·ªìn)

#### 1. Export T·∫•t C·∫£ Formats (Khuy·∫øn ngh·ªã)
```bash
cd ~/frappe-bench
python3 ~/insights-transfer/insights_manual_export_import.py export erp-sonnt.tiqn.local
```

**Output:**
```
‚úÖ Export completed successfully!
üìÅ Export location: ~/insights-transfer/insights_export_20240724_103015.zip
üìã Next steps:
   1. Copy ~/insights-transfer/insights_export_20240724_103015.zip to target server
   2. Run: python3 script.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015.zip
```

#### 2. Export Ch·ªâ JSON
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local json
```

#### 3. Export Ch·ªâ SQL
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local sql
```

#### 4. Export Ch·ªâ CSV
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local csv
```

### üìÇ C·∫•u Tr√∫c File Export

**ZIP Package (all format):**
```
insights_export_20240724_103015.zip (trong th∆∞ m·ª•c script)
‚îú‚îÄ‚îÄ export_summary.json              # T√≥m t·∫Øt export
‚îú‚îÄ‚îÄ insights_dashboard.json          # Dashboard data
‚îú‚îÄ‚îÄ insights_chart.json              # Chart data  
‚îú‚îÄ‚îÄ insights_query.json              # Query data
‚îú‚îÄ‚îÄ insights_data_source.json        # Data source data
‚îú‚îÄ‚îÄ insights_workbook.json           # Workbook data
‚îú‚îÄ‚îÄ insights_settings.json           # Settings data
‚îú‚îÄ‚îÄ insights_data.sql                # SQL dump
‚îî‚îÄ‚îÄ csv/                             # CSV files
    ‚îú‚îÄ‚îÄ insights_dashboard.csv
    ‚îú‚îÄ‚îÄ insights_chart.csv
    ‚îî‚îÄ‚îÄ ...
```

**JSON Only:**
```
~/insights-transfer/
‚îú‚îÄ‚îÄ insights_export_20240724_103015/
‚îÇ   ‚îú‚îÄ‚îÄ export_summary.json
‚îÇ   ‚îú‚îÄ‚îÄ insights_dashboard.json
‚îÇ   ‚îú‚îÄ‚îÄ insights_chart.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ insights_manual_export_import.py
```

## üìã Transfer Files Gi·ªØa Servers

### Ph∆∞∆°ng Ph√°p 1: SCP (Khuy·∫øn ngh·ªã)
```bash
# Copy ZIP file
scp ~/insights-transfer/insights_export_20240724_103015.zip user@target-server:~/insights-transfer/

# Copy th∆∞ m·ª•c JSON (n·∫øu export JSON only)
scp -r ~/insights-transfer/insights_export_20240724_103015/ user@target-server:~/insights-transfer/
```

### Ph∆∞∆°ng Ph√°p 2: SFTP
```bash
sftp user@target-server
put ~/insights-transfer/insights_export_20240724_103015.zip ~/insights-transfer/
quit
```

### Ph∆∞∆°ng Ph√°p 3: Cloud Storage
```bash
# Upload l√™n Google Drive/Dropbox/AWS S3
# R·ªìi download t·ª´ server ƒë√≠ch v√†o ~/insights-transfer/
```

### Ph∆∞∆°ng Ph√°p 4: USB/Physical Media
```bash
# Copy l√™n USB
cp ~/insights-transfer/insights_export_20240724_103015.zip /media/usb/

# Chuy·ªÉn USB sang server kh√°c v√† copy
cp /media/usb/insights_export_20240724_103015.zip ~/insights-transfer/
```

## üì• IMPORT DATA (Tr√™n Server ƒê√≠ch)

### 1. Import t·ª´ ZIP Package
```bash
cd ~/frappe-bench
python3 ~/insights-transfer/insights_manual_export_import.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015.zip
```

### 2. Import t·ª´ JSON Folder
```bash
python3 ~/insights-transfer/insights_manual_export_import.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015/
```

**Output Import:**
```
üöÄ Starting import to erp.tiqn.local
üìÅ Import from: ~/insights-transfer/insights_export_20240724_103015.zip
[10:30:15] INFO: Creating backup before import...
[10:30:16] INFO: Importing 5 records to Insights Dashboard
[10:30:16] INFO: Created: Sales Dashboard
[10:30:17] INFO: Updated: Analytics Dashboard
[10:30:18] INFO: ‚úÖ Imported 5/5 records from insights_dashboard.json
...
‚úÖ Import completed successfully!
üîî Please verify your data in Insights app
```

## üîß Scripts T·ª± ƒê·ªông H√≥a

### Export Script (`export_insights.sh`)
```bash
#!/bin/bash

SITE="erp-sonnt.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "üöÄ Starting Insights export..."

# Export
cd ~/frappe-bench
python3 $SCRIPT_PATH export $SITE

# T√¨m file export m·ªõi nh·∫•t trong script directory
EXPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$EXPORT_FILE" ]; then
    echo "‚úÖ Export completed: $EXPORT_FILE"
    echo "üìã File size: $(du -h $EXPORT_FILE | cut -f1)"
    echo ""
    echo "üì§ Transfer commands:"
    echo "   scp $EXPORT_FILE user@target-server:~/insights-transfer/"
    echo "   rsync -avz $EXPORT_FILE user@target-server:~/insights-transfer/"
else
    echo "‚ùå No export file found!"
fi
```

### Import Script (`import_insights.sh`)
```bash
#!/bin/bash

SITE="erp.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "üöÄ Starting Insights import..."

# T√¨m file import m·ªõi nh·∫•t trong script directory
IMPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$IMPORT_FILE" ]; then
    echo "üì¶ Import file: $IMPORT_FILE"
    echo "üìã File size: $(du -h $IMPORT_FILE | cut -f1)"
    
    # Import
    cd ~/frappe-bench
    python3 $SCRIPT_PATH import $SITE $IMPORT_FILE
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Import completed successfully!"
        echo "üîî Please check Insights app to verify data"
    else
        echo "‚ùå Import failed!"
    fi
else
    echo "‚ùå No import file found in $SCRIPT_DIR"
    echo "Available files:"
    ls -la $SCRIPT_DIR/insights_export_* 2>/dev/null || echo "   (none)"
fi
```

### Ch·∫°y Scripts:
```bash
# Tr√™n server ngu·ªìn
chmod +x export_insights.sh
./export_insights.sh

# Tr√™n server ƒë√≠ch
chmod +x import_insights.sh  
./import_insights.sh
```

## üîç Troubleshooting

### L·ªói Export

#### 1. "Site not found"
```bash
# Ki·ªÉm tra sites
bench --site all list-sites

# Ho·∫∑c
ls sites/
```

#### 2. "DocType not found"
```bash
# Ki·ªÉm tra Insights app
bench --site erp-sonnt.tiqn.local list-apps | grep insights

# C√†i ƒë·∫∑t n·∫øu thi·∫øu
bench --site erp-sonnt.tiqn.local install-app insights
```

#### 3. "Permission denied"
```bash
# Ki·ªÉm tra quy·ªÅn trong script directory
ls -la ~/insights-transfer/

# T·∫°o th∆∞ m·ª•c n·∫øu c·∫ßn
mkdir -p ~/insights-transfer
chmod 755 ~/insights-transfer
```

### L·ªói Transfer

#### 1. "No space left on device"
```bash
# Ki·ªÉm tra dung l∆∞·ª£ng
df -h

# D·ªçn d·∫πp files c≈© trong script directory
rm -f ~/insights-transfer/insights_export_*.zip
rm -rf ~/insights-transfer/insights_export_*/
```

#### 2. "Connection refused" (SCP)
```bash
# Ki·ªÉm tra SSH service tr√™n target
ssh user@target-server "sudo systemctl status ssh"

# Test connection
telnet target-server 22
```

#### 3. "File too large"
```bash
# N√©n file t·ªët h∆°n
cd /tmp
zip -9 insights_export_compressed.zip insights_export_*.zip

# Ho·∫∑c chia nh·ªè file
split -b 100M insights_export_large.zip insights_part_
```

### L·ªói Import

#### 1. "Import file not found"
```bash
# Ki·ªÉm tra file trong script directory
ls -la ~/insights-transfer/insights_export_*

# Ki·ªÉm tra n·ªôi dung ZIP
unzip -l ~/insights-transfer/insights_export_*.zip
```

#### 2. "Backup failed"
```bash
# T·∫°o backup manual
bench --site erp.tiqn.local backup

# Ho·∫∑c skip backup (kh√¥ng khuy·∫øn ngh·ªã)
# S·ª≠a trong script: comment d√≤ng backup
```

#### 3. "DocType not found in system"
```bash
# C√†i ƒë·∫∑t Insights app
bench --site erp.tiqn.local install-app insights

# Migrate
bench --site erp.tiqn.local migrate

# Restart
bench restart
```

## üìä Ki·ªÉm Tra K·∫øt Qu·∫£

### 1. Xem Export Summary
```bash
# Gi·∫£i n√©n v√† xem summary
unzip -p ~/insights-transfer/insights_export_*.zip export_summary.json | python3 -m json.tool
```

### 2. Verify Import Data
```bash
# V√†o Frappe console
bench --site erp.tiqn.local console
```

```python
# Ki·ªÉm tra s·ªë l∆∞·ª£ng records
doctypes = [
    "Insights Dashboard",
    "Insights Chart", 
    "Insights Query",
    "Insights Data Source",
    "Insights Workbook"
]

for dt in doctypes:
    try:
        count = frappe.db.count(dt)
        print(f"{dt}: {count} records")
    except:
        print(f"{dt}: DocType not found")

# Ki·ªÉm tra dashboard c·ª• th·ªÉ
dashboards = frappe.get_all("Insights Dashboard", fields=["name", "title"])
for d in dashboards:
    print(f"Dashboard: {d.name} - {d.title}")
```

### 3. Test Trong Insights App
1. **Login** v√†o ERPNext site ƒë√≠ch
2. **M·ªü Insights app**
3. **Ki·ªÉm tra Dashboards** hi·ªÉn th·ªã
4. **Test Charts** render ƒë√∫ng
5. **Verify Data Sources** connect ƒë∆∞·ª£c

## ‚ö†Ô∏è L∆∞u √ù Quan Tr·ªçng

### Tr∆∞·ªõc Khi Export:
- ‚úÖ **Backup site ngu·ªìn** ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n
- ‚úÖ **Ki·ªÉm tra dung l∆∞·ª£ng disk** tr√™n c·∫£ 2 servers
- ‚úÖ **Note l·∫°i c√°c custom settings** c√≥ th·ªÉ b·ªã m·∫•t

### Tr∆∞·ªõc Khi Import:
- ‚úÖ **Backup site ƒë√≠ch** (script t·ª± ƒë·ªông l√†m)
- ‚úÖ **ƒê·∫£m b·∫£o Insights app** ƒë√£ c√†i ƒë·∫∑t
- ‚úÖ **Ki·ªÉm tra version compatibility** gi·ªØa 2 sites

### Sau Khi Import: 
- ‚úÖ **Test to√†n b·ªô dashboards** ho·∫°t ƒë·ªông
- ‚úÖ **Ki·ªÉm tra data sources** c√≤n valid
- ‚úÖ **Verify user permissions** tr√™n items m·ªõi
- ‚úÖ **Update queries** n·∫øu c·∫ßn thi·∫øt

## üéØ Best Practices

### 1. Naming Convention
```bash
# ƒê·∫∑t t√™n file c√≥ √Ω nghƒ©a
insights_export_$(date +%Y%m%d)_$(hostname)_to_production.zip
```

### 2. Documentation
```bash
# T·∫°o file ghi ch√∫
cat > transfer_notes.txt << EOF
Transfer Date: $(date)
Source: erp-sonnt.tiqn.local  
Target: erp.tiqn.local
Exported Items:
- 5 Dashboards
- 12 Charts  
- 8 Queries
- 3 Data Sources
Notes: Transferred for production deployment
EOF
```

### 3. Version Control
```bash
# Git track export files (n·∫øu c·∫ßn)
git add insights_export_*.zip
git commit -m "Export insights data for production transfer"
```

### 4. Automation
```bash
# Cron job ƒë·ªÉ export ƒë·ªãnh k·ª≥
0 2 * * 0 cd /home/frappe/frappe-bench && python3 ~/insights-transfer/insights_manual_export_import.py export erp-sonnt.tiqn.local >/tmp/export.log 2>&1
```

## üìû H·ªó Tr·ª£

### Log Files
```bash
# Check export logs
tail -f /tmp/insights_export_*/export.log

# Check import logs  
tail -f /tmp/insights_import.log
```

### Debug Mode
Th√™m debug v√†o script:
```python
def log(self, message, level="INFO"):
    timestamp = datetime.now().strftime('%H:%M:%S')
    log_msg = f"[{timestamp}] {level}: {message}"
    print(log_msg)
    
    # Debug file
    with open("/tmp/insights_debug.log", "a") as f:
        f.write(log_msg + "\n")
```

---

**üí° Pro Tips:**
- Lu√¥n test tr√™n dev environment tr∆∞·ªõc
- S·ª≠ d·ª•ng rsync v·ªõi `--progress` ƒë·ªÉ track transfer l·ªõn
- Compress ZIP v·ªõi level 9 ƒë·ªÉ ti·∫øt ki·ªám bƒÉng th√¥ng: `zip -9`
- Backup kh√¥ng ch·ªâ data m√† c·∫£ customizations