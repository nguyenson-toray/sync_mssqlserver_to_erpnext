# HÆ°á»›ng Dáº«n Export/Import Thá»§ CÃ´ng Insights Data

## ðŸ“‹ Tá»•ng Quan

Script `insights_manual_export_import.py` Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ export Insights data thÃ nh cÃ¡c file cÃ³ thá»ƒ transfer thá»§ cÃ´ng giá»¯a cÃ¡c servers khÃ¡c nhau.

### âœ¨ TÃ­nh NÄƒng:
- ðŸ—ƒï¸ **Export Ä‘a Ä‘á»‹nh dáº¡ng**: JSON, SQL, CSV
- ðŸ“¦ **Táº¡o ZIP package** chá»©a táº¥t cáº£ formats
- ðŸ”„ **Import tá»± Ä‘á»™ng** tá»« JSON hoáº·c ZIP
- ðŸ›¡ï¸ **Backup tá»± Ä‘á»™ng** trÆ°á»›c khi import
- ðŸ“Š **BÃ¡o cÃ¡o chi tiáº¿t** quÃ¡ trÃ¬nh export/import

### ðŸ“ CÃ¡c Data ÄÆ°á»£c Transfer:
- âœ… **Dashboards** - Báº£ng Ä‘iá»u khiá»ƒn
- âœ… **Workbooks** - Sá»• lÃ m viá»‡c  
- âœ… **Data Sources** - Nguá»“n dá»¯ liá»‡u
- âœ… **Charts** - Biá»ƒu Ä‘á»“
- âœ… **Queries** - Truy váº¥n
- âœ… **Settings** - CÃ i Ä‘áº·t

## ðŸ› ï¸ YÃªu Cáº§u Há»‡ Thá»‘ng

### TrÃªn Cáº£ 2 Servers:
- **ERPNext/Frappe Framework** Ä‘Ã£ cÃ i Ä‘áº·t
- **Insights App** Ä‘Ã£ cÃ i Ä‘áº·t
- **Python 3.x**
- **Quyá»n truy cáº­p** bench commands

### Kiá»ƒm Tra Insights App:
```bash
# Kiá»ƒm tra app
bench --site your-site list-apps | grep insights

# CÃ i Ä‘áº·t náº¿u chÆ°a cÃ³
bench get-app insights
bench --site your-site install-app insights
```

## ðŸ“¥ CÃ i Äáº·t Script

### 1. Táº£i Script
```bash
# Táº¡o thÆ° má»¥c
mkdir -p ~/insights-transfer
cd ~/insights-transfer

# Táº¡o script file
nano insights_manual_export_import.py
# (Copy ná»™i dung tá»« artifact)

# PhÃ¢n quyá»n
chmod +x insights_manual_export_import.py
```

### 2. Test Script
```bash
# Test script
python3 insights_manual_export_import.py
```

## ðŸš€ CÃ¡ch Sá»­ Dá»¥ng

### ðŸ“¤ EXPORT DATA (TrÃªn Server Nguá»“n)

#### 1. Export Táº¥t Cáº£ Formats (Khuyáº¿n nghá»‹)
```bash
cd ~/frappe-bench
python3 ~/insights-transfer/insights_manual_export_import.py export erp-sonnt.tiqn.local
```

**Output:**
```
âœ… Export completed successfully!
ðŸ“ Export location: ~/insights-transfer/insights_export_20240724_103015.zip
ðŸ“‹ Next steps:
   1. Copy ~/insights-transfer/insights_export_20240724_103015.zip to target server
   2. Run: python3 script.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015.zip
```

#### 2. Export Chá»‰ JSON
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local json
```

#### 3. Export Chá»‰ SQL
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local sql
```

#### 4. Export Chá»‰ CSV
```bash
python3 insights_manual_export_import.py export erp-sonnt.tiqn.local csv
```

### ðŸ“‚ Cáº¥u TrÃºc File Export

**ZIP Package (all format):**
```
insights_export_20240724_103015.zip (trong thÆ° má»¥c script)
â”œâ”€â”€ export_summary.json              # TÃ³m táº¯t export
â”œâ”€â”€ insights_dashboard.json          # Dashboard data
â”œâ”€â”€ insights_chart.json              # Chart data  
â”œâ”€â”€ insights_query.json              # Query data
â”œâ”€â”€ insights_data_source.json        # Data source data
â”œâ”€â”€ insights_workbook.json           # Workbook data
â”œâ”€â”€ insights_settings.json           # Settings data
â”œâ”€â”€ insights_data.sql                # SQL dump
â””â”€â”€ csv/                             # CSV files
    â”œâ”€â”€ insights_dashboard.csv
    â”œâ”€â”€ insights_chart.csv
    â””â”€â”€ ...
```

**JSON Only:**
```
~/insights-transfer/
â”œâ”€â”€ insights_export_20240724_103015/
â”‚   â”œâ”€â”€ export_summary.json
â”‚   â”œâ”€â”€ insights_dashboard.json
â”‚   â”œâ”€â”€ insights_chart.json
â”‚   â””â”€â”€ ...
â””â”€â”€ insights_manual_export_import.py
```

## ðŸ“‹ Transfer Files Giá»¯a Servers

### PhÆ°Æ¡ng PhÃ¡p 1: SCP (Khuyáº¿n nghá»‹)
```bash
# Copy ZIP file
scp ~/insights-transfer/insights_export_20240724_103015.zip user@target-server:~/insights-transfer/

# Copy thÆ° má»¥c JSON (náº¿u export JSON only)
scp -r ~/insights-transfer/insights_export_20240724_103015/ user@target-server:~/insights-transfer/
```

### PhÆ°Æ¡ng PhÃ¡p 2: SFTP
```bash
sftp user@target-server
put ~/insights-transfer/insights_export_20240724_103015.zip ~/insights-transfer/
quit
```

### PhÆ°Æ¡ng PhÃ¡p 3: Cloud Storage
```bash
# Upload lÃªn Google Drive/Dropbox/AWS S3
# Rá»“i download tá»« server Ä‘Ã­ch vÃ o ~/insights-transfer/
```

### PhÆ°Æ¡ng PhÃ¡p 4: USB/Physical Media
```bash
# Copy lÃªn USB
cp ~/insights-transfer/insights_export_20240724_103015.zip /media/usb/

# Chuyá»ƒn USB sang server khÃ¡c vÃ  copy
cp /media/usb/insights_export_20240724_103015.zip ~/insights-transfer/
```

## ðŸ“¥ IMPORT DATA (TrÃªn Server ÄÃ­ch)

### 1. Import tá»« ZIP Package
```bash
cd ~/frappe-bench
python3 ~/insights-transfer/insights_manual_export_import.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015.zip
```

### 2. Import tá»« JSON Folder
```bash
python3 ~/insights-transfer/insights_manual_export_import.py import erp.tiqn.local ~/insights-transfer/insights_export_20240724_103015/
```

**Output Import:**
```
ðŸš€ Starting import to erp.tiqn.local
ðŸ“ Import from: ~/insights-transfer/insights_export_20240724_103015.zip
[10:30:15] INFO: Creating backup before import...
[10:30:16] INFO: Importing 5 records to Insights Dashboard
[10:30:16] INFO: Created: Sales Dashboard
[10:30:17] INFO: Updated: Analytics Dashboard
[10:30:18] INFO: âœ… Imported 5/5 records from insights_dashboard.json
...
âœ… Import completed successfully!
ðŸ”” Please verify your data in Insights app
```

## ðŸ”§ Scripts Tá»± Äá»™ng HÃ³a

### Export Script (`export_insights.sh`)
```bash
#!/bin/bash

SITE="erp-sonnt.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "ðŸš€ Starting Insights export..."

# Export
cd ~/frappe-bench
python3 $SCRIPT_PATH export $SITE

# TÃ¬m file export má»›i nháº¥t trong script directory
EXPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$EXPORT_FILE" ]; then
    echo "âœ… Export completed: $EXPORT_FILE"
    echo "ðŸ“‹ File size: $(du -h $EXPORT_FILE | cut -f1)"
    echo ""
    echo "ðŸ“¤ Transfer commands:"
    echo "   scp $EXPORT_FILE user@target-server:~/insights-transfer/"
    echo "   rsync -avz $EXPORT_FILE user@target-server:~/insights-transfer/"
else
    echo "âŒ No export file found!"
fi
```

### Import Script (`import_insights.sh`)
```bash
#!/bin/bash

SITE="erp.tiqn.local"
SCRIPT_DIR="~/insights-transfer"
SCRIPT_PATH="$SCRIPT_DIR/insights_manual_export_import.py"

echo "ðŸš€ Starting Insights import..."

# TÃ¬m file import má»›i nháº¥t trong script directory
IMPORT_FILE=$(ls -t $SCRIPT_DIR/insights_export_*.zip 2>/dev/null | head -1)

if [ -f "$IMPORT_FILE" ]; then
    echo "ðŸ“¦ Import file: $IMPORT_FILE"
    echo "ðŸ“‹ File size: $(du -h $IMPORT_FILE | cut -f1)"
    
    # Import
    cd ~/frappe-bench
    python3 $SCRIPT_PATH import $SITE $IMPORT_FILE
    
    if [ $? -eq 0 ]; then
        echo "âœ… Import completed successfully!"
        echo "ðŸ”” Please check Insights app to verify data"
    else
        echo "âŒ Import failed!"
    fi
else
    echo "âŒ No import file found in $SCRIPT_DIR"
    echo "Available files:"
    ls -la $SCRIPT_DIR/insights_export_* 2>/dev/null || echo "   (none)"
fi
```

### Cháº¡y Scripts:
```bash
# TrÃªn server nguá»“n
chmod +x export_insights.sh
./export_insights.sh

# TrÃªn server Ä‘Ã­ch
chmod +x import_insights.sh  
./import_insights.sh
```

## ðŸ” Troubleshooting

### Lá»—i Export

#### 1. "Site not found"
```bash
# Kiá»ƒm tra sites
bench --site all list-sites

# Hoáº·c
ls sites/
```

#### 2. "DocType not found"
```bash
# Kiá»ƒm tra Insights app
bench --site erp-sonnt.tiqn.local list-apps | grep insights

# CÃ i Ä‘áº·t náº¿u thiáº¿u
bench --site erp-sonnt.tiqn.local install-app insights
```

#### 3. "Permission denied"
```bash
# Kiá»ƒm tra quyá»n trong script directory
ls -la ~/insights-transfer/

# Táº¡o thÆ° má»¥c náº¿u cáº§n
mkdir -p ~/insights-transfer
chmod 755 ~/insights-transfer
```

### Lá»—i Transfer

#### 1. "No space left on device"
```bash
# Kiá»ƒm tra dung lÆ°á»£ng
df -h

# Dá»n dáº¹p files cÅ© trong script directory
rm -f ~/insights-transfer/insights_export_*.zip
rm -rf ~/insights-transfer/insights_export_*/
```

#### 2. "Connection refused" (SCP)
```bash
# Kiá»ƒm tra SSH service trÃªn target
ssh user@target-server "sudo systemctl status ssh"

# Test connection
telnet target-server 22
```

#### 3. "File too large"
```bash
# NÃ©n file tá»‘t hÆ¡n
cd /tmp
zip -9 insights_export_compressed.zip insights_export_*.zip

# Hoáº·c chia nhá» file
split -b 100M insights_export_large.zip insights_part_
```

### Lá»—i Import

#### 1. "Import file not found"
```bash
# Kiá»ƒm tra file trong script directory
ls -la ~/insights-transfer/insights_export_*

# Kiá»ƒm tra ná»™i dung ZIP
unzip -l ~/insights-transfer/insights_export_*.zip
```

#### 2. "Backup failed"
```bash
# Táº¡o backup manual
bench --site erp.tiqn.local backup

# Hoáº·c skip backup (khÃ´ng khuyáº¿n nghá»‹)
# Sá»­a trong script: comment dÃ²ng backup
```

#### 3. "DocType not found in system"
```bash
# CÃ i Ä‘áº·t Insights app
bench --site erp.tiqn.local install-app insights

# Migrate
bench --site erp.tiqn.local migrate

# Restart
bench restart
```

## ðŸ“Š Kiá»ƒm Tra Káº¿t Quáº£

### 1. Xem Export Summary
```bash
# Giáº£i nÃ©n vÃ  xem summary
unzip -p ~/insights-transfer/insights_export_*.zip export_summary.json | python3 -m json.tool
```

### 2. Verify Import Data
```bash
# VÃ o Frappe console
bench --site erp.tiqn.local console
```

```python
# Kiá»ƒm tra sá»‘ lÆ°á»£ng records
doctypes = [
    "Insights Dashboard",
    "Insights Chart", 
    "Insights Query",
    "Insights Data Source",
    "Insights Workbook"
]

for dt in doctypes:
    try:
        count = frappe.db.count(dt)
        print(f"{dt}: {count} records")
    except:
        print(f"{dt}: DocType not found")

# Kiá»ƒm tra dashboard cá»¥ thá»ƒ
dashboards = frappe.get_all("Insights Dashboard", fields=["name", "title"])
for d in dashboards:
    print(f"Dashboard: {d.name} - {d.title}")
```

### 3. Test Trong Insights App
1. **Login** vÃ o ERPNext site Ä‘Ã­ch
2. **Má»Ÿ Insights app**
3. **Kiá»ƒm tra Dashboards** hiá»ƒn thá»‹
4. **Test Charts** render Ä‘Ãºng
5. **Verify Data Sources** connect Ä‘Æ°á»£c

## âš ï¸ LÆ°u Ã Quan Trá»ng

### TrÆ°á»›c Khi Export:
- âœ… **Backup site nguá»“n** Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n
- âœ… **Kiá»ƒm tra dung lÆ°á»£ng disk** trÃªn cáº£ 2 servers
- âœ… **Note láº¡i cÃ¡c custom settings** cÃ³ thá»ƒ bá»‹ máº¥t

### TrÆ°á»›c Khi Import:
- âœ… **Backup site Ä‘Ã­ch** (script tá»± Ä‘á»™ng lÃ m)
- âœ… **Äáº£m báº£o Insights app** Ä‘Ã£ cÃ i Ä‘áº·t
- âœ… **Kiá»ƒm tra version compatibility** giá»¯a 2 sites

### Sau Khi Import: 
- âœ… **Test toÃ n bá»™ dashboards** hoáº¡t Ä‘á»™ng
- âœ… **Kiá»ƒm tra data sources** cÃ²n valid
- âœ… **Verify user permissions** trÃªn items má»›i
- âœ… **Update queries** náº¿u cáº§n thiáº¿t

## ðŸŽ¯ Best Practices

### 1. Naming Convention
```bash
# Äáº·t tÃªn file cÃ³ Ã½ nghÄ©a
insights_export_$(date +%Y%m%d)_$(hostname)_to_production.zip
```

### 2. Documentation
```bash
# Táº¡o file ghi chÃº
cat > transfer_notes.txt << EOF
Transfer Date: $(date)
Source: erp-sonnt.tiqn.local  
Target: erp.tiqn.local
Exported Items:
- 5 Dashboards
- 12 Charts  
- 8 Queries
- 3 Data Sources
Notes: Transferred for production deployment
EOF
```

### 3. Version Control
```bash
# Git track export files (náº¿u cáº§n)
git add insights_export_*.zip
git commit -m "Export insights data for production transfer"
```

### 4. Automation
```bash
# Cron job Ä‘á»ƒ export Ä‘á»‹nh ká»³
0 2 * * 0 cd /home/frappe/frappe-bench && python3 ~/insights-transfer/insights_manual_export_import.py export erp-sonnt.tiqn.local >/tmp/export.log 2>&1
```

## ðŸ“ž Há»— Trá»£

### Log Files
```bash
# Check export logs
tail -f /tmp/insights_export_*/export.log

# Check import logs  
tail -f /tmp/insights_import.log
```

### Debug Mode
ThÃªm debug vÃ o script:
```python
def log(self, message, level="INFO"):
    timestamp = datetime.now().strftime('%H:%M:%S')
    log_msg = f"[{timestamp}] {level}: {message}"
    print(log_msg)
    
    # Debug file
    with open("/tmp/insights_debug.log", "a") as f:
        f.write(log_msg + "\n")
```

---

**ðŸ’¡ Pro Tips:**
- LuÃ´n test trÃªn dev environment trÆ°á»›c
- Sá»­ dá»¥ng rsync vá»›i `--progress` Ä‘á»ƒ track transfer lá»›n
- Compress ZIP vá»›i level 9 Ä‘á»ƒ tiáº¿t kiá»‡m bÄƒng thÃ´ng: `zip -9`
- Backup khÃ´ng chá»‰ data mÃ  cáº£ customizations